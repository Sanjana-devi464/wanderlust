<% layout("layouts/boilerplate") %>

<div class="row mt-3">
    <div class="col-10 offset-1">
        <!-- Listing Title Section -->
        <div class="listing-header mb-4">
            <h1 class="listing-main-title"><%= listing.title %></h1>
            <div class="listing-subtitle">
                <span class="location-text">
                    <i class="fas fa-map-marker-alt me-2"></i>
                    <%= listing.location %>, <%= listing.country %>
                </span>
                <span class="hosted-by ms-3">
                    <i class="fas fa-user me-2"></i>
                    Hosted by 
                    <% if(listing.owner && listing.owner.username) { %>
                        <strong><%= listing.owner.username %></strong>
                    <% } else { %>
                        <strong>Unknown User</strong>
                    <% } %>
                </span>
            </div>
        </div>

        <!-- Broader Image Section -->
        <div class="listing-image-container mb-4">
            <img
                src="<%= listing.image && listing.image.url ? listing.image.url : 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?ixlib=rb-4.0.3&auto=format&fit=crop&w=1400&q=85' %>" 
                class="listing-main-image" 
                alt="<%= listing.title %>" 
            >
        </div>

        <!-- Listing Details Card -->
        <div class="listing-details-card">
            <div class="card-body p-4">
                <div class="listing-info-grid">
                    <div class="description-section mb-4">
                        <h5 class="section-title">About this listing</h5>
                        <p class="listing-description"><%= listing.description %></p>
                    </div>
                    
                    <div class="pricing-section mb-4">
                        <div class="price-display">
                            <span class="price-amount">₹<%= listing.price.toLocaleString("en-IN") %></span>
                            <span class="price-period">per night</span>
                        </div>
                    </div>
                </div>

                <div class="btn-group-show mt-4">
                    <% if (currentUser && !listing.owner && currentUser.isAdmin) { %>
                        <form method="POST" action="/admin/listings/<%= listing._id %>/claim" style="display:inline" onsubmit="return confirm('Claim ownership of this legacy listing?');">
                            <button type="submit" class="btn btn-warning">Claim Ownership</button>
                        </form>
                    <% } %>
                    <% if(currentUser && listing.owner && currentUser._id.equals(listing.owner._id)) { %>
                        <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary me-2">Edit Listing</a>
                        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="display: inline;">
                            <button type="submit" class="btn btn-danger me-2" onclick="return confirm('Are you sure you want to delete this listing?')">Delete Listing</button>
                        </form>
                    <% } %>
                    <a href="/listings" class="btn btn-secondary">Back to All Listings</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reviews and Map Section -->
<div class="container mt-5">
    <div class="row">
        <div class="col-10 offset-1">
        <!-- Professional Review Form -->
        <div class="review-form-section">
            <% if(currentUser) { %>
                <div class="review-form-card">
                    <h4 class="review-form-title">Write a Review</h4>
                    <p class="review-form-subtitle">Share your experience with this listing</p>
                    
                    <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation professional-review-form">
                        <div class="rating-section mb-4">
                            <label class="rating-label">Your Rating:</label>
                            <div class="star-rating-input">
                                <fieldset class="starability-slot">
                                    <legend class="sr-only">Rating:</legend>
                                    <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                                    <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                    <label for="first-rate1" title="Poor - 1 star">1 star</label>
                                    <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                    <label for="first-rate2" title="Fair - 2 stars">2 stars</label>
                                    <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                    <label for="first-rate3" title="Good - 3 stars">3 stars</label>
                                    <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                    <label for="first-rate4" title="Very Good - 4 stars">4 stars</label>
                                    <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                    <label for="first-rate5" title="Excellent - 5 stars">5 stars</label>
                                </fieldset>
                                <div class="rating-labels">
                                    <span class="rating-label-text">Poor</span>
                                    <span class="rating-label-text">Fair</span>
                                    <span class="rating-label-text">Good</span>
                                    <span class="rating-label-text">Very Good</span>
                                    <span class="rating-label-text">Excellent</span>
                                </div>
                            </div>
                        </div>

                        <div class="comment-section mb-4">
                            <label for="comment" class="form-label comment-label">Your Review:</label>
                            <textarea 
                                id="comment" 
                                name="review[comment]" 
                                rows="4" 
                                class="form-control professional-textarea" 
                                placeholder="Tell others about your experience with this listing..."
                                required
                                minlength="10"
                                maxlength="500"
                            ></textarea>
                            <div class="invalid-feedback">Please enter a valid review comment (minimum 10 characters)</div>
                            <div class="character-count">
                                <small class="form-text text-muted">
                                    <span id="char-count">0</span>/500 characters
                                </small>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-submit-review">
                                <i class="fas fa-paper-plane me-2"></i>
                                Submit Review
                            </button>
                        </div>
                    </form>
                </div>
            <% } else { %>
                <div class="login-prompt-card">
                    <div class="login-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <h4>Want to Leave a Review?</h4>
                    <p>Please log in to share your experience and help other travelers.</p>
                    <a href="/login" class="btn btn-login">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        Login to Review
                    </a>
                </div>
            <% } %>
        </div>
        <hr/>

        <!-- Professional Reviews Section -->
        <div class="reviews-section mt-4">
            <div class="reviews-header mb-4">
                <h3 class="reviews-title">Customer Reviews & Ratings</h3>
                <div class="overall-rating-summary">
                    <% if(listing.reviews && listing.reviews.length > 0) { %>
                        <% 
                            const totalRating = listing.reviews.reduce((sum, review) => sum + review.rating, 0);
                            const avgRating = (totalRating / listing.reviews.length).toFixed(1);
                            const fullStars = Math.floor(avgRating);
                            const hasHalfStar = avgRating % 1 >= 0.5;
                            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                        %>
                        <div class="rating-overview">
                            <div class="average-rating">
                                <span class="rating-number"><%= avgRating %></span>
                                <div class="stars-display">
                                    <% for(let i = 0; i < fullStars; i++) { %>
                                        <i class="fas fa-star text-warning"></i>
                                    <% } %>
                                    <% if(hasHalfStar) { %>
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                    <% } %>
                                    <% for(let i = 0; i < emptyStars; i++) { %>
                                        <i class="far fa-star text-muted"></i>
                                    <% } %>
                                </div>
                            </div>
                            <div class="rating-info">
                                <span class="total-reviews">Based on <%= listing.reviews.length %> review<%= listing.reviews.length > 1 ? 's' : '' %></span>
                            </div>
                        </div>
                    <% } else { %>
                        <p class="no-reviews">No reviews yet. Be the first to review!</p>
                    <% } %>
                </div>
            </div>

            <!-- Individual Reviews -->
            <div class="reviews-list">
                <% for (review of listing.reviews) { %>
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-avatar">
                                    <% 
                                        let username = 'Unknown User';
                                        if(review.author && typeof review.author === 'object' && review.author.username) {
                                            username = review.author.username;
                                        } else if(typeof review.author === 'string') {
                                            username = review.author;
                                        }
                                        const initials = username.substring(0, 2).toUpperCase();
                                    %>
                                    <span class="avatar-text"><%= initials %></span>
                                </div>
                                <div class="reviewer-details">
                                    <h6 class="reviewer-name"><%= username %></h6>
                                    <div class="review-rating">
                                        <% for(let i = 1; i <= 5; i++) { %>
                                            <i class="<%= i <= review.rating ? 'fas' : 'far' %> fa-star <%= i <= review.rating ? 'text-warning' : 'text-muted' %>"></i>
                                        <% } %>
                                        <span class="rating-text">(<%= review.rating %>/5)</span>
                                    </div>
                                    <div class="review-date">
                                        <small class="text-muted">
                                            <%= new Date(review.createdAt).toLocaleDateString('en-US', { 
                                                year: 'numeric', 
                                                month: 'long', 
                                                day: 'numeric' 
                                            }) %>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="review-actions">
                                <% /* Determine if current user can delete this review */ %>
                                <% const canDeleteReview = currentUser && (
                                            (review.author && review.author._id && currentUser._id.equals(review.author._id)) ||
                                            (review.author && review.author.equals && review.author.equals(currentUser._id)) ||
                                            (listing.owner && listing.owner._id && currentUser._id.equals(listing.owner._id))
                                     ); %>
                                <% if (canDeleteReview) { %>
                                    <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" class="delete-review-form" onsubmit="return confirm('Delete this review?');">
                                        <button type="submit" class="btn-delete-review" title="Delete review">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                <% } %>
                            </div>
                        </div>
                        <div class="review-content">
                            <p class="review-text"><%= review.comment %></p>
                        </div>
                        <div class="review-footer">
                            <button class="helpful-btn">
                                <i class="far fa-thumbs-up"></i>
                                <span>Helpful</span>
                            </button>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    
    <!-- Map Section with Airbnb-style layout -->
    <div class="container mt-5 mb-5 map-section">
        <div class="row">
            <div class="col-12">
                <h2 class="text-start mb-4" style="font-size: 1.375rem; font-weight: 600; color: #222;">Where you'll be</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="map">
                    <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: #717171;">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p style="font-size: 14px;">Loading map...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <p style="color: #717171; font-size: 14px; margin-bottom: 0;">
                    <%= listing.location %>, <%= listing.country %>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Data script for map -->
<script type="application/json" id="listing-data">
  <%- JSON.stringify(cleanListing) %>
</script>

<script>
// Embed map code directly in the page
console.log('🗺️ Starting map initialization...');
console.log('MapToken exists:', '<%= process.env.MAP_TOKEN %>' !== '');

// Wait for page to load
window.addEventListener('load', function() {
    const mapContainer = document.getElementById('map');
    const mapToken = '<%= process.env.MAP_TOKEN %>';
    const listingDataElement = document.getElementById('listing-data');
    const listing = JSON.parse(listingDataElement.textContent);
    
    console.log('🔍 Page loaded, checking requirements...');
    console.log('Map container found:', mapContainer !== null);
    console.log('MapboxGL available:', typeof mapboxgl !== 'undefined');
    
    if (!mapContainer) {
        console.error('❌ Map container not found');
        return;
    }
    
    if (typeof mapboxgl === 'undefined') {
        console.error('❌ Mapbox GL JS not loaded');
        mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: red; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">Mapbox library not loaded</p>';
        return;
    }
    
    if (!mapToken) {
        console.error('❌ Map token missing');
        mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: red; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">Map token not configured</p>';
        return;
    }
    
    if (!listing || !listing.geometry || !listing.geometry.coordinates) {
        console.error('❌ Listing coordinates missing');
        mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: red; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">Location data not available</p>';
        return;
    }
    
    try {
        console.log('✅ All requirements met, creating map...');
        console.log('📍 Coordinates:', listing.geometry.coordinates);
        
        mapboxgl.accessToken = mapToken;
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: listing.geometry.coordinates,
            zoom: 12,
            scrollZoom: true,
            boxZoom: true,
            dragRotate: false,
            dragPan: true,
            keyboard: true,
            doubleClickZoom: true,
            touchZoomRotate: true
        });
        
        console.log('✅ Map created successfully');
        
        // Add custom Airbnb-style marker
        const markerElement = document.createElement('div');
        markerElement.className = 'custom-marker';
        markerElement.style.cssText = `
            background: #FF385C;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        markerElement.innerHTML = '<i class="fas fa-home" style="color: white; font-size: 14px;"></i>';
        
        new mapboxgl.Marker(markerElement)
            .setLngLat(listing.geometry.coordinates)
            .setPopup(
                new mapboxgl.Popup({ 
                    offset: 25,
                    className: 'airbnb-popup'
                })
                .setHTML(`
                    <div style="padding: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <h5 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600; color: #222;">${listing.location}</h5>
                        <p style="margin: 0; font-size: 12px; color: #717171;">Exact location provided after booking</p>
                    </div>
                `)
            )
            .addTo(map);
            
        console.log('✅ Marker added successfully');
        
        map.on('load', function() {
            console.log('🎉 Map fully loaded and ready!');
        });
        
        map.on('error', function(e) {
            console.error('❌ Map error:', e);
            mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: red; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">Failed to load map: ' + e.message + '</p>';
        });
        
    } catch (error) {
        console.error('❌ Error initializing map:', error);
        mapContainer.innerHTML = '<p style="padding: 20px; text-align: center; color: red; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;">Map initialization failed: ' + error.message + '</p>';
    }
});
</script>

<!-- Review Form Enhancement Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Character counter for review textarea
    const commentTextarea = document.getElementById('comment');
    const charCount = document.getElementById('char-count');
    
    if (commentTextarea && charCount) {
        commentTextarea.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
            
            // Change color based on character count
            if (count < 10) {
                charCount.style.color = '#dc3545';
            } else if (count > 450) {
                charCount.style.color = '#ffc107';
            } else {
                charCount.style.color = '#28a745';
            }
        });
    }
    
    // Star rating visual feedback
    const starInputs = document.querySelectorAll('input[name="review[rating]"]');
    const ratingLabels = document.querySelectorAll('.rating-label-text');
    
    starInputs.forEach((input, index) => {
        input.addEventListener('change', function() {
            // Reset all labels
            ratingLabels.forEach(label => label.style.fontWeight = 'normal');
            ratingLabels.forEach(label => label.style.color = '#666');
            
            // Highlight selected rating label
            if (index > 0 && ratingLabels[index - 1]) { // Skip the "no-rate" input
                ratingLabels[index - 1].style.fontWeight = 'bold';
                ratingLabels[index - 1].style.color = '#ff6b35';
            }
        });
    });
    
    // Helpful button functionality
    const helpfulBtns = document.querySelectorAll('.helpful-btn');
    helpfulBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.classList.contains('clicked')) {
                this.innerHTML = '<i class="far fa-thumbs-up"></i><span>Helpful</span>';
                this.classList.remove('clicked');
            } else {
                this.innerHTML = '<i class="fas fa-thumbs-up text-primary"></i><span>Thanks!</span>';
                this.classList.add('clicked');
            }
        });
    });
});
</script>

